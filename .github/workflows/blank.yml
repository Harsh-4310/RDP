name: Windows RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Set up RDP user
        shell: pwsh
        run: |
          Write-Host "üîß Creating RDP user..."
          $password = [System.Web.Security.Membership]::GeneratePassword(16,3)
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          try {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member "RDP"
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
              echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
              Write-Host "‚úÖ User 'RDP' created successfully."
          } catch {
              Write-Host "‚ö†Ô∏è Failed to create RDP user: $($_.Exception.Message)"
          }

      - name: Install Tailscale
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing Tailscale..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installer`"", "/quiet" -Wait
          Remove-Item $installer -Force
          Write-Host "‚úÖ Tailscale installed successfully."

      - name: Connect to Tailscale
        shell: pwsh
        run: |
          Write-Host "üîó Connecting to Tailscale..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TS_AUTHKEY }}
          
          $tsIP = $null
          for ($i=0; $i -lt 10; $i++) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($tsIP) { break }
              Start-Sleep -Seconds 5
          }

          if (-not $tsIP) {
              Write-Host "‚ö†Ô∏è Tailscale IP not found."
              exit 0
          }

          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Connected. Tailscale IP: $tsIP"

      - name: Show RDP Info
        shell: pwsh
        run: |
          Write-Host "`n==============================="
          Write-Host "üíª RDP Session Information"
          Write-Host "Tailscale IP : $env:TAILSCALE_IP"
          Write-Host "Username     : RDP"
          Write-Host "Password     : $env:RDP_PASSWORD"
          Write-Host "==============================="
          Write-Host "‚ö° Keep this runner open while using RDP."
          Write-Host "‚èπ Use Ctrl+C in Actions log to stop manually."

          while ($true) {
              Write-Host "[{0}] üü¢ RDP session active..." -f (Get-Date)
              Start-Sleep -Seconds 300
          }
